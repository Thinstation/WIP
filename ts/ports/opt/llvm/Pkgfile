# Maintainer: Evangelos Foutras <evangelos@foutrelis.com>
# Contributor: Jan "heftig" Steffens <jan.steffens@gmail.com>

name=llvm
version=16.0.6
release=1
_source_base=https://github.com/llvm/llvm-project/releases/download/llvmorg-$version
source=($_source_base/llvm-$version.src.tar.xz{,.sig}
        $_source_base/cmake-$version.src.tar.xz{,.sig}
        $_source_base/third-party-$version.src.tar.xz{,.sig})

_get_distribution_components() {
  local target
  ninja -t targets | grep -Po 'install-\K.*(?=-stripped:)' | while read -r target; do
    case $target in
      llvm-libraries|distribution)
        continue
        ;;
      # shared libraries
      LLVM|LLVMgold)
        ;;
      # libraries needed for clang-tblgen
      LLVMDemangle|LLVMSupport|LLVMTableGen)
        ;;
      # exclude static libraries
      LLVM*)
        continue
        ;;
      # exclude llvm-exegesis (doesn't seem useful without libpfm)
      llvm-exegesis)
        continue
        ;;
    esac
    echo $target
  done
}

build() {
  rename -v -- "-$version.src" '' {cmake,third-party}-$version.src
  cd llvm-$version.src
  mkdir build
  cd build

  # Build only minimal debug info to reduce size
  CFLAGS=${CFLAGS/-g /-g1 }
  CXXFLAGS=${CXXFLAGS/-g /-g1 }

  local cmake_args=(
    -G Ninja
    -DCMAKE_BUILD_TYPE=Release
    -DCMAKE_INSTALL_DOCDIR=share/doc
    -DCMAKE_INSTALL_PREFIX=/usr
    -DCMAKE_SKIP_RPATH=ON
    -DLLVM_BINUTILS_INCDIR=/usr/include
    -DLLVM_BUILD_DOCS=ON
    -DLLVM_BUILD_LLVM_DYLIB=ON
    -DLLVM_BUILD_TESTS=ON
    -DLLVM_ENABLE_BINDINGS=OFF
    -DLLVM_ENABLE_FFI=ON
    -DLLVM_ENABLE_RTTI=ON
    -DLLVM_ENABLE_SPHINX=ON
    -DLLVM_HOST_TRIPLE=x86_64
    -DLLVM_INCLUDE_BENCHMARKS=OFF
    -DLLVM_INSTALL_UTILS=ON
    -DLLVM_LINK_LLVM_DYLIB=ON
    -DLLVM_USE_PERF=ON
    -DSPHINX_WARNINGS_AS_ERRORS=OFF
  )

  cmake .. "${cmake_args[@]}"
  local distribution_components=$(_get_distribution_components | paste -sd\;)
  test -n "$distribution_components"
  cmake_args+=(-DLLVM_DISTRIBUTION_COMPONENTS="$distribution_components")

  cmake .. "${cmake_args[@]}"
  ninja

  DESTDIR="$PKG" ninja install-distribution

  # Include lit for running lit-based tests in other projects
  pushd ../utils/lit
  python3 setup.py install --root="$PKG" -O1
  popd

  # The runtime libraries go into llvm-libs
  mv -f "$PKG"/usr/lib/lib{LLVM,LTO,Remarks}*.so* "$SRC"
  mv -f "$PKG"/usr/lib/LLVMgold.so "$SRC"

  # Remove documentation sources
  rm -r "$PKG"/usr/share/doc/llvm/html/{_sources,.buildinfo}

  install -Dm644 ../LICENSE.TXT "$PKG/usr/share/licenses/$name/LICENSE"
  install -d "$PKG/usr/lib"
  cp -P \
    "$SRC"/lib{LLVM,LTO,Remarks}*.so* \
    "$SRC"/LLVMgold.so \
    "$PKG/usr/lib/"

  # Symlink LLVMgold.so from /usr/lib/bfd-plugins
  # https://bugs.archlinux.org/task/28479
  install -d "$PKG/usr/lib/bfd-plugins"
  ln -s ../LLVMgold.so "$PKG/usr/lib/bfd-plugins/LLVMgold.so"

  install -Dm644 "$SRC/llvm-$version.src/LICENSE.TXT" \
    "$PKG/usr/share/licenses/$name/LICENSE"
}

# vim:set ts=2 sw=2 et:
